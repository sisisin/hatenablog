---
Title: Aurora ServerlessとECS Fargateで動くRailsアプリのクエリチューニングをした
Date: 2019-08-03T23:46:04+09:00
URL: https://sisisin.hateblo.jp/entry/2019/08/03/234604
EditURL: https://blog.hatena.ne.jp/sisisin444/sisisin.hateblo.jp/atom/entry/26006613385758641
---

tl; dr
  
- Aurora Serverlessの場合はスロークエリログ有効化設定がAWS上にある
- DataAPIを有効化すればクエリ叩き放題で最高
- チューニングのためのはじめの一歩として、パフォーマンス計測のための環境整備をインフラやアプリに合わせて適宜構築するのが大事  

結果としてやったことはただ単純にslow query logを有効化して該当のクエリをexplainして直しただけ  
  

### 前提

アプリケーションサーバー

- ECS Fargate
- Ruby on Rails

DB

- Aurora Serverless
- MySQL 5.6

インフラの構成管理にはAWS CDK経由でCloudFormationを利用  

### 準備

まずスロークエリログを見たい or APMでアプリのボトルネックを見たい、というところからスタート  
スロークエリログ有効化の方が手っ取り早いし多分クエリが遅いはずだと思ってたのでひとまずスロークエリログから着手した  

#### スロークエリログ有効化

Aurora Serverlessを利用している関係で直接MySQLのログを見ることは出来ない  
CloudWatchLogsに吐かせる設定がコンソールやCFnなどから出来るのでその設定をした  

参考: 

[https://dev.classmethod.jp/cloud/aws/uploading-to-cloudwatch-aurora-serverless/:title]


*aws-cdk@0.20.0 を利用（古いのはご愛嬌）

```typescript
const dbParameterGroup = new rds.ClusterParameterGroup(this, 'DBParameterGroup', {
      family: 'aurora5.6',
      description: `Parameter Groups`,
      parameters: {
        slow_query_log: 1,
      },
    });
    const cluster = new rds.cloudformation.DBClusterResource(this, 'Database', {
      dbClusterParameterGroupName: dbParameterGroup.parameterGroupName,
      // 中略
    });
```

スロークエリログで何度も叩かれてそうな上に遅いクエリを見つけたのでとりあえずそいつをexplainしたいということになったので今度はその準備をすることに。  

#### DBインスタンスにクエリを実行する

結論としては、Aurora ServerlessのDataAPIを有効化してAWSコンソールから直接クエリできるQueryEditorを利用した  
参考: [https://dev.classmethod.jp/cloud/aws/query-editor-for-aurora-serverless/:title]  
  
  

他の選択肢はこんな感じだった

- ecs-cliのrunコマンド経由でrails runnerを利用してモデルのクエリをexplainする
  - ECSタスクを毎回立ち上げてクエリしてその結果をCloudWatchLogsで確認、という流れなので死ぬほど面倒
- gatewayサーバー立ててssh
  - EC2立てるだけっちゃだけだけど、その辺手慣れてるメンバーがチームにいないので微妙に腰が重かったしお金もかかる
- ALBで一時的にVPCトンネルをつくる・・・？
  - 風のうわさでそういうことが出来ると聞いたけどよくわからなかった

### 結果

ここまででスロークエリを探してexplain出来るようになったので、該当のクエリを見てみたらwhereされてないサブクエリの結果セットが80万行とかになっていたのが原因ということが判明  
適当にモデルのクエリを調整していい感じに速くなった。めでたしめでたし。  

### APMについて

チューニングしたときには活用しなかったけどちょろっと調べたり動かしたりしたので一応メモ  

あがった選択肢

- NewRelic
  - gem入れるだけで動かせてお手軽
  - ECSの料金体系についてドキュメントがなく、問い合わせて見積もりもらわないとわからないので会社員的に地味に辛め
    - ＊そのぐらいポンッと使わせてくれない会社が悪いという説もある
- AWS X-Ray
    - ECSの場合エージェント用のタスクを立ち上げる必要があるのでNewRelicに比べると導入めんどい
    - ドキュメントにもRailsのサンプルがなく、多少試行錯誤しそうだったので動かして見るところまではまだやってない
- DataDog APM
  - NewRelicよりは安そうだった
  - あまりちゃんと調べてない


### 感想

Aurora Serverlessが便利だった（こなみかん）  
  
---
  
実はこのクエリチューニングはチームで1日時間をとってISUCON大会と称して合宿したときの成果で、それはそれで良かったという話もあったり。  
スロークエリを探しつつAPMをアプリ得意な人が準備したり、explainするときに何見ればいいのかとか横からアドバイスもらったりしながらワイワイやれて楽しかった。  
  
うちのチームは様々な事情でバックエンドエンジニア不足のためにこの手のタスクの進みが悪いので、こうやってISUCON大会してガッと進められたのはめっちゃよかった
