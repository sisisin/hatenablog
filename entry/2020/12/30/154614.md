---
Title: Rubyの静的型解析を触った感想を書いたりする
Date: 2020-12-30T15:46:14+09:00
URL: https://sisisin.hateblo.jp/entry/2020/12/30/154614
EditURL: https://blog.hatena.ne.jp/sisisin444/sisisin.hateblo.jp/atom/entry/26006613671838091
---

この記事は [Opt Technologies Advent Calendar 2020](https://qiita.com/advent-calendar/2020/opt-technologies) 10 日目記事です  
12/25にリリースしたRuby 3.0を使った話をしているので時空が歪んでるように見えますが気のせいです  
  
9 日目の記事は [@shachitaku](https://qiita.com/shachitaku) さんの [M5StickC x JoyStick HATで寝ながらパソコンを操作できるBluetoothマウスを作ってみた](https://qiita.com/shachitaku/items/bd3992f6d4c1527cb260) です  
11 日目の記事は [@shoyaokayama](https://qiita.com/shoyaokayama) さんの [LINEThingsとM5CoreInkを使ってO2Oマーケティングを体験してみる](https://qiita.com/shoyaokayama/items/ba65c1d024255a40ecb6) です  
  
---

Ruby 3.0の目玉機能として静的型解析のサポートが挙げられるでしょう  
最近仕事ではRailsを書いてるけど、もともと静的型付け派な自分としては大変気になる機能なので試してみて感想を書き残しておこうと思った次第  
  
良かった点は静的に型情報を解析できるようになる、に尽きるので、基本的に足りない点を指摘することに終始する点、ご了承いただければと  

### 結論

まだ早い（そりゃそう）  
自分が求める体験との乖離が結構大きかったのと、エコシステムが粗く、これからどんどん変化していくと思うので追従が当面の間かなり大変だろうという所感  
（実際に使ってフィードバックしたりして貢献していかないと進化していかないだろうから使いたい気持ちもある）  

### 触った感想とか

- steep checkが遅い
  - rails newしただけのコードを全解析すると15secほどかかった（MacBookPro 13inch 2019モデル）
  - ファイルに閉じてるエディタ上での解析は気にならないけど、やっぱりクラスを書き換えたらそのクラスの利用側でコンパイルエラーが出てる場所を全て見る、というような利用シーンにプロジェクト全体のコンパイルは必須なのでこれが遅いのはしんどい
- 実装を変更するたびに型定義を更新しないといけない
  - watchモードもなさそう・仮にあったとしてもtsでの経験上、ファイルシステムを挟んでしまうと遅くなるので今後パフォーマンス対策大変そう（Steep,TypeProf,エディタがそれぞれ全て速くないと良い開発体験にならなそう）
  - これは仕組み上しょうがないので、上手いこと良い開発体験になるエコシステムが出来てくるといいなあと思った
- エディタサポートが弱い
  - RubyMineやSolargraphが「実装への」定義ジャンプまでやってくれるのに対してsteep-vscodeは*.rbファイル上で実装を書くときにメソッドのシグネチャが補完されるだけ
  - RBSをRuby本体にバンドルしているので、LanguageServer実装も本体に入れて実装へのジャンプや型定義取得などが自在にできるようになっててほしい（それが出来るのかは・・・）（RubyMineの定義ジャンプなんかはRails向けに相当気を利かせた実装になってるようだし、それ相当の体験をRuby本体がバンドルするようなツールが出来るのかというと・・・みたいな）
- 現状はRBS作ってもuntypedな部分を厳格にしようとすると生成したコードを書き換える必要がありそう？
  - 理想的には実装を書き換える→TypeProfによるコード生成→自動で補完！だと思うけど、そうなると自動生成されたRBSファイルを直接変更じゃなくて上書きのような形にしないと継続的にTypeProfの世話になることが出来なくて難しそう。どういう方針なんだろう
- 型定義ファイルの取得方法がgemなどのツールでサポートされていない（git submoduleとかで取ってきてそのパスを指定する必要がある）
  - これはSteepの問題ではあるけど、SteepってRubyにバンドルされてるわけじゃないから、そこまでgemなどの公式サイドのツール側でサポートしてくれるようになるんだろうか？という疑問はある
- irbのようなREPL環境でも型情報が使えるようになってほしい

### その他の感想

そもそも疑問なんだけど、型定義ファイルの生成と型定義ファイルそのものを扱うライブラリが本体にバンドルされても静的解析ツール（Steep）が本体に入らないのってどういう理由なんだろうか  
RBSファイルの存在は最終的にSteepありきになるはずなのでSteepに特化した機能を入れたくなりそうなもんだけど非公式のツール相手にそこまでやれるもんなんか、みたいな    
Rubyの開発方針とか詳しくないので、本体には入ってないけど実質公式みたいなもんだからいい、みたいなのもありそうではあるけど  

### 終わりに

まだ実装を書いておらず、ほぼツールチェイン周りへの感想なのだけど、それでこれだけ出てくるので中々に前途多難を感じる  
CIとか組み込んで実際の開発体制に組み込めるか？という点や型の解析周りでの感想は追々やっていけたらなと  


### 参考資料・関連リンク

[https://pocke.hatenablog.com/entry/2020/12/25/183535:title]

[https://github.com/soutaro/steep-vscode:title]

[https://qiita.com/jnchito/items/bf8c6c2e1dd6cff05f4e#%E8%87%AA%E5%88%86%E3%81%A7%E4%BD%9C%E3%81%A3%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AB%E5%9E%8B%E5%AE%9A%E7%BE%A9%E3%82%92%E4%BB%98%E3%81%91%E3%82%8B:title]


[https://github.com/ruby/rbs/blob/master/docs/syntax.md:title]

[https://techlife.cookpad.com/entry/2020/12/09/120454:title]

[https://techlife.cookpad.com/entry/2020/12/09/120314:title]

